{% extends "base.html" %}

{% set primary_page = True %}
{% set page_name = "Profile" + (" - Admin" if user_is_admin else "") %}

{% block title %}Bitter - Profile{% endblock %}

{% block style %}
<link rel="stylesheet", type="text/css", href="{{ url_for('static', filename='styles/profile.css') }}">
{% endblock %}

{% block content %}

<img id="pfp" class="hidden" src="{{ url_for('uploads', category='user_pfps') }}/{{ user_id }}.png" alt="User's profile picture">

<form id="update-profile-form" class="hidden" action="{{ url_for('update_profile') }}" method="post" enctype="multipart/form-data">
    <label for="pfp">Choose new profile picture (&lt;{{ max_pfp_size / (1024**2) }} MB)</label>
    <input type="file" name="pfp" accept="image/*" id="pfp-input">
    <label for="display-name">Choose new display name</label>
    <input type="text" name="display-name" maxlength="{{ display_name_max_len }}" id="display-name-input">
    <label for="username">Usernames can't be changed</label>
    <input type="text" name="username" placeholder="@" maxlength="{{ username_max_len }}" disabled id="username-input">
    <input type="submit" value="Update profile" id="update-profile-button" class="green-button"></input>
</form>

<div id="signout-button" class="green-button hidden">Sign-out</div>

<div class="loading-icon"><svg><use href="{{ url_for('static', filename='img/sprites.svg') }}#icon-loading"></svg></div>

{% for message in get_flashed_messages() %}
<p class="flash-message">{{message}}</p>
{% endfor %}

<script>
    let pfp_img = document.getElementById("pfp")
    let update_profile_form = document.getElementById("update-profile-form")
    let display_name_input = document.getElementById("display-name-input")
    let username_input = document.getElementById("username-input")
    let signout_button = document.getElementById("signout-button")
    let loading_icon = document.querySelector(".loading-icon")

    update_profile_form.reset()
    document.getElementById("signout-button")
        .addEventListener("click", () => (window.location = "{{ url_for('signout') }}"))
    
    fetch("{{ url_for('fetch_own_profile') }}", {method: "GET"})
        .then(resp => {
            let is_json = resp.headers.get('Content-Type') === "application/json"
            return Promise.all([is_json ? resp.json() : resp.text(), resp.ok])
        })
        .then((resp_data) => {
            resp_content = resp_data[0]
            ok = resp_data[1]

            if (!ok) {
                console.log(resp_content)
                window.location = `{{ url_for('signout') }}`
                return
            }

            console.log(resp_content)

            display_name_input.value = resp_content["display_name"]
            username_input.value = "@" + resp_content["username"]

            pfp_img.classList.remove("hidden")
            update_profile_form.classList.remove("hidden")
            signout_button.classList.remove("hidden")
            loading_icon.classList.add("hidden")
        })

</script>

{% endblock %}

